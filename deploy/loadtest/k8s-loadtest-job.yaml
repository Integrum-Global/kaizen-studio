apiVersion: v1
kind: Namespace
metadata:
  name: loadtest
  labels:
    app.kubernetes.io/name: kaizen-studio-loadtest
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-scripts
  namespace: loadtest
data:
  smoke.js: |
    // Smoke test script - embedded for Kubernetes
    import http from 'k6/http';
    import { check, sleep } from 'k6';

    export const options = {
      vus: 5,
      duration: '30s',
      thresholds: {
        http_req_duration: ['p(95)<500'],
        http_req_failed: ['rate<0.01'],
      },
    };

    const BASE_URL = __ENV.BASE_URL || 'http://kaizen-studio-backend.kaizen-studio.svc.cluster.local:8000';

    export default function() {
      const res = http.get(`${BASE_URL}/health`);
      check(res, {
        'status is 200': (r) => r.status === 200,
        'response time < 500ms': (r) => r.timings.duration < 500,
      });
      sleep(1);
    }
---
apiVersion: batch/v1
kind: Job
metadata:
  name: kaizen-studio-loadtest-smoke
  namespace: loadtest
  labels:
    app.kubernetes.io/name: kaizen-studio-loadtest
    app.kubernetes.io/component: smoke-test
spec:
  ttlSecondsAfterFinished: 86400
  backoffLimit: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kaizen-studio-loadtest
        app.kubernetes.io/component: smoke-test
    spec:
      restartPolicy: Never
      containers:
        - name: k6
          image: grafana/k6:0.48.0
          command: ['k6', 'run', '--out', 'json=/results/results.json', '/scripts/smoke.js']
          env:
            - name: BASE_URL
              value: "http://kaizen-studio-backend.kaizen-studio.svc.cluster.local:8000"
            - name: K6_OUT
              value: "json=/results/results.json"
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          volumeMounts:
            - name: scripts
              mountPath: /scripts
              readOnly: true
            - name: results
              mountPath: /results
      volumes:
        - name: scripts
          configMap:
            name: k6-scripts
        - name: results
          emptyDir: {}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: kaizen-studio-loadtest-stress
  namespace: loadtest
  labels:
    app.kubernetes.io/name: kaizen-studio-loadtest
    app.kubernetes.io/component: stress-test
spec:
  ttlSecondsAfterFinished: 86400
  backoffLimit: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kaizen-studio-loadtest
        app.kubernetes.io/component: stress-test
    spec:
      restartPolicy: Never
      containers:
        - name: k6
          image: grafana/k6:0.48.0
          command: ['k6', 'run', '--vus', '100', '--duration', '5m', '/scripts/smoke.js']
          env:
            - name: BASE_URL
              value: "http://kaizen-studio-backend.kaizen-studio.svc.cluster.local:8000"
          resources:
            requests:
              cpu: "1000m"
              memory: "1Gi"
            limits:
              cpu: "2000m"
              memory: "2Gi"
          volumeMounts:
            - name: scripts
              mountPath: /scripts
              readOnly: true
            - name: results
              mountPath: /results
      volumes:
        - name: scripts
          configMap:
            name: k6-scripts
        - name: results
          emptyDir: {}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kaizen-studio-loadtest-nightly
  namespace: loadtest
  labels:
    app.kubernetes.io/name: kaizen-studio-loadtest
    app.kubernetes.io/component: nightly-test
spec:
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 172800
      backoffLimit: 1
      template:
        metadata:
          labels:
            app.kubernetes.io/name: kaizen-studio-loadtest
            app.kubernetes.io/component: nightly-test
        spec:
          restartPolicy: Never
          containers:
            - name: k6
              image: grafana/k6:0.48.0
              command: ['k6', 'run', '--vus', '50', '--duration', '10m', '/scripts/smoke.js']
              env:
                - name: BASE_URL
                  value: "http://kaizen-studio-backend.kaizen-studio.svc.cluster.local:8000"
              resources:
                requests:
                  cpu: "500m"
                  memory: "512Mi"
                limits:
                  cpu: "1000m"
                  memory: "1Gi"
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
                  readOnly: true
                - name: results
                  mountPath: /results
          volumes:
            - name: scripts
              configMap:
                name: k6-scripts
            - name: results
              emptyDir: {}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: loadtest-runner
  namespace: loadtest
rules:
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "delete", "get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: loadtest-runner-binding
  namespace: loadtest
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: loadtest-runner
subjects:
  - kind: ServiceAccount
    name: default
    namespace: loadtest
